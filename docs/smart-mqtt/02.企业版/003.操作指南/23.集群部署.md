---
title: 集群部署
date: 2022-12-03 16:42:26
permalink: /smart-mqtt/cluster.html
---

smart-mqtt 支持多个 Broker 服务组织成一套分布式集群。

任意一个 Broker 接收到外部投递的消息后，除了推送给与当前Broker连接的客户端；
还会分发给集群内其他匹配订阅规则的 Broker 节点，再由该节点将消息推送给与之连接的客户端。

![](../img/cluster.svg)
::: tip
而对于 Broker 分发过来的消息，不会被集群内的接受者 Broker 二次分发。
:::

## 如何使用
启用集群功能只需要在配置文件中加入以下配置值。
```yaml
plugins:
  - enterprise:
      cluster:
        enable: true
        nodes:
          - mqtt://cluster-node-1:1883
          - mqtt://cluster-node-2:1883
          - mqtts://cluster-node-3:1883
```
- **enable**：是否启用集群功能。
- **nodes**：集群中其他节点通信地址。内网环境推荐使用`mqtt://`互联，可获得更好的通信性能。若涉及到跨网络、跨云的集群模式，通过启用`mqtts://`以获得数据安全保障。
::: warning
- 修改配置文件后需重启服务方可生效。
- 集群节点数需限定在获得授权的范围内，如需扩容请重新发起授权申请。
:::
## 负载均衡（Load Balance）
为了提高 MQTT Broker 集群的可用性、实现负载平衡以及动态扩容，生产场景下通常在客户端与 Broker 集群之间架设一套负载均衡服务。

如果出于安全需要客户端启用 TLS 安全连接，也可将其终止于 Load Balance。Load Balance 与 后端 Broker 集群采用普通 TCP 连接。

![](../img/lb_cluster.png)

市面上多家云厂商都提供了 LB 产品可供选择。倘若需要私有部署可考虑以下产品：
|开源LB|地址|
|---|---|
| Haproxy|[https://www.haproxy.com/solutions/load-balancing/](https://www.haproxy.com/solutions/load-balancing/)|
| Nginx|[https://www.nginx.com/learn/load-balancing/](https://www.nginx.com/learn/load-balancing/)|