---
title: 数据持久化
date: 2022-12-03 16:42:26
permalink: /smart-mqtt/db.html
---


## 一、持久化方式
smart-mqtt 企业版将提供相对自由的数据持久化选型。目前已经适配了：H2 和 MySQL 两种数据库，其中 H2 数据库又分为**内存模式**和**文件模式**。

选择不同的持久化策略，会有着不同的服务效果：
- h2_mem   
H2数据库的内存模式，重启服务将会丢失数据，通常用于**企业版的演示环境**。
- h2   
H2 数据库的文件模式，会在运行包的同目录下生成`smart-mqtt.mv.db`文件，选择该模式会在重启Broker服务时会保留历史数据。  
该模式的优点在于无外部依赖，开箱即用。单缺点是多个Broker服务无法共享同一个 H2 数据库文件，不适用Broker集群环境。
- mysql  
可靠性相对较高的持久化模式。多 Broker 连接同一数据库可方便组织成集群，各节点信息、数据交互便利。   
缺点在于需要额外维护 MySQL 服务，好在目前此类数据库通常由云厂商托管了，也算省心省力。

## 二、持久化内容
### 2.1 MQTT Broker 节点配置
- 节点名称
- 版本号
- 运行服务器IP
- 进程号
- 最近一次内存使用率
- 最近一次CPU使用率
- 最近一次启动时间时间
- 节点创建时间
### 2.2 客户端订阅的Topic的列表
- 客户端ClientID
- 订阅 Topic
- 订阅的 Topic QoS
- 连接的 Broker 地址

### 2.3 客户端与Broker的连接配置
- 客户端ClientID
- 连接认证信息
- 当前连接状态
- 连接的 Broker 地址
- 客户端地址
- 心跳间隔
- 最近一次建立连接的时间

### 2.4 运行指标

### 2.5 ChatGPT账户管理及日志
- 客户端账户
- ChatGPT 分配的资源总额度
- 已消耗的额度
- 与ChatGPT 的对话日志

## 配置示例
```yaml
plugins:
  - database:
      # h2_mem、h2、mysql
      dbType: h2
```
>  若未显式指定持久化模式，将默认选择：**h2_mem**