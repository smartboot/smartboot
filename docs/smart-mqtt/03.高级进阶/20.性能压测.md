---
title: 性能压测
date: 2022-12-08 17:56:00
permalink: /smart-mqtt/performance.html
---

很多用户比较关心 smart-mqtt 的性能表现，为了得出一个相对客观的结论。我们选用 emqtt-bench 分别对 emq 和 smart-mqtt 进行压测。 

::: tip
本文只会分享如何进行压测，不会展示评测结果。比较在意性能的朋友可根据本文指导的步骤在自己的服务器上亲自验证。
:::
## 环境准备
一台装有Docker，且非 arm 架构的Linux服务器、Windows 或者 Macbook。

> emqtt-bench没有提供arm架构的镜像。

## Connect Benchmark
## Sub Benchmark

## Pub Benchmark
### 压测 emq
```yaml
networks:
  mqtt-network:
    driver: bridge
services:
  emqx:
    container_name: emqx
    hostname: emqx-mqtt
    image: emqx/emqx:latest
    networks:
      mqtt-network: null
    restart: always
    security_opt:
      - no-new-privileges:true
    user: root:root
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "1"

  emq-bench:
    depends_on:
      - emqx
    image: emqx/emqtt-bench
    restart: always
    security_opt:
      - no-new-privileges:true
    user: root:root
    networks:
      mqtt-network: null
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "1"
    command: pub --host emqx-mqtt -c 10000 -i 1 -I 0 -t bench/%i -p 1883 -u smart-mqtt -P smart-mqtt -s 1024 -V 4
version: '3.7'
```
1. 创建 `docker-compose.yml` 文件，并输入上面内容。
2. 打开终端，并切换至`docker-compose.yml`所在目录执行命令：`docker compose up -d`
3. 执行命令观察日志：`docker compose logs -f emq-bench --tail 20`。由于 emq 启动需要些许时间，前期 emq-bench会在控制台打印大量的错误日志：connect error - econnrefused，耐心等待即可。
4. 当压测数据稳定后，退出日志观察，执行`docker compose down`销毁压测环境。

### 压测 smart-mqt
```yaml
networks:
  mqtt-network:
    driver: bridge
services:
  smart-mqtt:
    container_name: smart-mqtt
    hostname: smart-mqtt
    image: smartboot/smart-mqtt:0.9
    networks:
      mqtt-network: null
    read_only: true
    restart: always
    security_opt:
      - no-new-privileges:true
    user: root:root
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "1"

  emq-bench:
    depends_on:
      - smart-mqtt
    image: emqx/emqtt-bench
    read_only: true
    restart: always
    security_opt:
      - no-new-privileges:true
    user: root:root
    networks:
      mqtt-network: null
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "1"
    command: pub --host smart-mqtt -c 10000 -i 1 -I 0 -t bench/%i -p 1883 -u mica -P mica -s 1024 -V 4

version: '3.7'
```
1. 创建 `docker-compose.yml` 文件，并输入上面内容。
2. 打开终端，并切换至`docker-compose.yml`所在目录执行命令：`docker compose up -d`
3. 执行命令观察日志：`docker compose logs -f emq-bench --tail 20`。
4. 当压测数据稳定后，退出日志观察，执行`docker compose down`销毁压测环境。

