---
title: 性能压测
date: 2022-12-08 17:56:00
permalink: /smart-mqtt/performance.html
---

很多用户比较关心 smart-mqtt 的性能表现，为了得出一个相对客观的结论。我们通过自研的压测工具分别对 emqx 和 smart-mqtt 进行压测。
::: tip
本文只会分享如何进行压测，不会展示评测结果。比较在意性能的朋友可根据本文指导的步骤在自己的服务器上亲自验证。
:::
## 关于压测工具
早些时候也调研了一下市面上的MQTT压测工具，相对来说`emqtt-bench`是个不错的选择。
但是由于该工具只提供了 amd64 的 Docker 镜像，而我本人的常用开发电脑是 ARM 架构，所以不太适用。

况且开发一款压测工具也并非难事，干脆自己写一个 Java 版的 MQTT 压测工具：**`smart-mqtt-bench`**。
## 环境准备
一台装有 Docker 的 Linux服务器、Windows 或者 Macbook。
> 支持主流的 amd64 和 arm64 架构。

## 压测步骤
下文提供了多种场景的压测脚本，皆可按以下步骤操作：
1. 创建 `docker-compose.yml` 文件，并输入压测脚本容。
2. 打开终端，并切换至`docker-compose.yml`所在目录执行命令：`docker compose up -d`
3. 执行命令观察日志：`docker compose logs -f`。
4. 当压测数据稳定后，退出日志观察，执行`docker compose down`销毁压测环境。

## 压测脚本
### Connect Benchmark
待验证...
### Sub Benchmark
`smart-mqtt-bench.command`参数说明：

|参数名| 参数描述                             |
|---|----------------------------------|
|host| MQTT Broker地址，已针对压测对象配置完成，无需调整。  |
|port| MQTT Broekr服务的端口号，默认：1883，不推荐调整。 |
|connect| 压测客户端数量，默认：1000，可按需调整。           |
|payload| 压测消息的 payload 字节数，默认：128，可按需调整。  |
|topic| 压测订阅的Topic数量，默认：128，可按需调整。       |
|publisher| 负责生产消息的客户端数量，默认：1。               |
|count| 每个publisher周期内发送的消息数量，默认：1。      |
每秒中发送的最多消息数为：`publisher * count * 500`，所以`connect`个订阅者产生订阅量理论值为：`publisher * count * 500 * connect`。
##### emqx压测脚本
```yaml
networks:
  mqtt-network:
    driver: bridge
services:
  emqx:
    container_name: emqx
    hostname: emqx-mqtt
    image: emqx/emqx:5.0.3
    networks:
      mqtt-network: null
    restart: always
    security_opt:
    - no-new-privileges:true
    user: root:root
    logging:
        driver: "json-file"
        options:
            max-size: "100m"
            max-file: "1"

  smart-mqtt-bench:
    depends_on:
      - emqx
    image: smartboot/smart-mqtt-bench:latest
    read_only: true
    restart: always
    security_opt:
      - no-new-privileges:true
    user: root:root
    networks:
      mqtt-network: null
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "1"
    command: java -cp smart-mqtt-bench.jar  -Dhost=emqx-mqtt -Dconnect=2000 -Dpublisher=2 -Dcount=3 -Dpayload=128 org.smartboot.bench.mqtt.Subscribe
version: '3.7'
```

##### smart-mqtt压测脚本
```yaml
networks:
  mqtt-network:
    driver: bridge
services:
  smart-mqtt:
    container_name: smart-mqtt
    hostname: smart-mqtt
    image: smartboot/smart-mqtt:latest
    networks:
      mqtt-network: null
    read_only: true
    restart: always
    security_opt:
      - no-new-privileges:true
    user: root:root
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "1"

  smart-mqtt-bench:
    depends_on:
      - smart-mqtt
    image: smartboot/smart-mqtt-bench:latest
    read_only: true
    restart: always
    security_opt:
      - no-new-privileges:true
    user: root:root
    networks:
      mqtt-network: null
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "1"
    command: java -cp smart-mqtt-bench.jar  -Dhost=smart-mqtt -Dconnect=2000 -Dpublisher=2 -Dcount=3 -Dpayload=128 org.smartboot.bench.mqtt.Subscribe
version: '3.7'
```

### Pub Benchmark
`smart-mqtt-bench.command`参数说明：

|参数名| 参数描述                             |
|---|----------------------------------|
|host| MQTT Broker地址，已针对压测对象配置完成，无需调整。  |
|port| MQTT Broekr服务的端口号，默认：1883，不推荐调整。 |
|connect| 压测客户端数量，默认：1000，可按需调整。           |
|payload| 压测消息的 payload 字节数，默认：1024，可按需调整。 |
|topic| 压测订阅的Topic数量，默认：128，可按需调整。       |
|count| 每个publisher周期内发送的消息数量，默认：1。      |
每秒中发送的最多消息数为：`connect * count * 500`。
#### emqx压测脚本
```yaml
networks:
  mqtt-network:
    driver: bridge
services:
  emqx:
    container_name: emqx
    hostname: emqx-mqtt
    image: emqx/emqx:5.0.3
    networks:
      mqtt-network: null
    restart: always
    security_opt:
    - no-new-privileges:true
    user: root:root
    logging:
        driver: "json-file"
        options:
            max-size: "100m"
            max-file: "1"

  smart-mqtt-bench:
    depends_on:
      - emqx
    image: smartboot/smart-mqtt-bench:latest
    read_only: true
    restart: always
    security_opt:
      - no-new-privileges:true
    user: root:root
    networks:
      mqtt-network: null
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "1"
    command: java -cp smart-mqtt-bench.jar  -Dhost=emqx-mqtt -Dconnect=1000 -Dcount=3 -Dpayload=128 org.smartboot.bench.mqtt.Publish
version: '3.7'
```

#### smart-mqt压测脚本
```yaml
networks:
  mqtt-network:
    driver: bridge
services:
  smart-mqtt:
    container_name: smart-mqtt
    hostname: smart-mqtt
    image: smartboot/smart-mqtt:latest
    networks:
      mqtt-network: null
    read_only: true
    restart: always
    security_opt:
      - no-new-privileges:true
    user: root:root
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "1"

  smart-mqtt-bench:
    depends_on:
      - smart-mqtt
    image: smartboot/smart-mqtt-bench:latest
    read_only: true
    restart: always
    security_opt:
      - no-new-privileges:true
    user: root:root
    networks:
      mqtt-network: null
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "1"
    command: java -cp smart-mqtt-bench.jar  -Dhost=smart-mqtt -Dconnect=1000 -Dcount=3 -Dpayload=128 org.smartboot.bench.mqtt.Publish
version: '3.7'
```

