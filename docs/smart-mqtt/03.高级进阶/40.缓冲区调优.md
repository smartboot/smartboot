---
title: 缓冲区调优
date: 2022-12-09 13:05:16
permalink: /smart-mqtt/buffer-optimize.html
---

缓冲区是 MQTT 在通信过程中用于存放数据的内存片段，正确的容量配置策略可以达到内存开销与通信性能的最佳平衡点。

为每个TCP连接分配的读缓冲区大小，是在服务启动前便以参数配置的形式确定下来，运行期不可更改。

所以，**过小的配置值将使得缓冲区无法容纳一个完整的 MQTT 消息包，导致解码异常**；**而过大的容量配置，又会带来内存浪费的问题**。

![](./img/buffer_optimize_1.png)

为了最大化提升资源的利用率，我们引入了临时缓冲区的策略。
当消息大小超过默认的读缓冲区容量时，通过申请一片足够大小的临时空间，完成消息解码后再将其释放掉。

:::tip 思考
这个时候我们只需思考一个问题：如何设置读缓冲区的大小？
:::