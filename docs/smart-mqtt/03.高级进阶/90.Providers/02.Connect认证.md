---
title: Connect认证
date: 2022-12-29 21:06:38
permalink: /smart-mqtt/provider-connect.html
---

Connect 认证用于校验客户端与Broker建立通信连接的合法性。
smart-mqtt 默认提供的是基于简单的账号/密码认证方式，使用时只需在 smart-mqtt.yaml 中配置相应的参数即可，如下：

```yaml
broker:
  username: smart-mqtt
  password: smart-mqtt
```
启用 Connect 认证后，客户端在 Connect 消息中携带的认证信息必须与 Broker 端配置的一致，
否则 Broker 会遵循协议规范返回`0x05`的响应码并断开TCP连接。

但是 smart-mqtt 默认提供的认证方式存在一定局限性，比如所有客户端共用同一套认证账户；账号、密码被显式配置在 smart-mqtt.yaml 存在安全隐患等。

### 接口定义
如果需要实现一套符合企业自身需求的认证方案，可以结合[插件](../10.插件开发.md)技术和`ConnectAuthenticationProvider`接口重新实现连接认证。
```java
public interface ConnectAuthenticationProvider {
    boolean authentication(MqttConnectMessage connectMessage, MqttSession session);
}
```
- 入参：
  - MqttConnectMessage：客户端Connect认证的原始消息。
  - MqttSession：当前的连接会话。
- 出参：
  - true：认证通过。
  - false：认证失败，连接将被断开。

### 示例
```java
public class ConnectAuthenticationPlugin extends Plugin {
    @Override
    protected void initPlugin(BrokerContext brokerContext) {
        brokerContext.getProviders().setConnectAuthenticationProvider(new ConnectAuthenticationProvider() {
            @Override
            public boolean authentication(MqttConnectMessage connectMessage, MqttSession session) {
                //重写 Connect 认证逻辑
                //查询数据库认证，或者调用远程服务认证
                ...

                // true:认证通过; false:认证失败
                return false;
            }
        });
    }
}
```