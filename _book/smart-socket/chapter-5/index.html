<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>第四章 内存池 | SmartBoot</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="manifest" href="/book/manifest.webmanifest" crossorigin="use-credentials">
    <meta name="description" content="">
    <meta property="og:url" content="/book/smart-socket/chapter-5/">
    <meta property="og:site_name" content="SmartBoot">
    <meta property="og:title" content="第四章 内存池">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="en-US">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image:alt" content="SmartBoot">
    <meta name="theme-color" content="#46bd87">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <link rel="preload" href="/book/assets/css/0.styles.b07082da.css" as="style"><link rel="preload" href="/book/assets/js/app.6eb622a1.js" as="script"><link rel="preload" href="/book/assets/js/layout-Layout.6827866a.js" as="script"><link rel="preload" href="/book/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.ac8a61b1.js" as="script"><link rel="preload" href="/book/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-Slide.2a107b58.js" as="script"><link rel="preload" href="/book/assets/js/vendors~layout-Blog~layout-Layout.4f275bc9.js" as="script"><link rel="preload" href="/book/assets/js/page-第四章内存池.4f602f0e.js" as="script"><link rel="prefetch" href="/book/assets/js/35.dc053720.js"><link rel="prefetch" href="/book/assets/js/36.87a9911d.js"><link rel="prefetch" href="/book/assets/js/37.abc908ed.js"><link rel="prefetch" href="/book/assets/js/38.1ee90c2d.js"><link rel="prefetch" href="/book/assets/js/39.fa399e4d.js"><link rel="prefetch" href="/book/assets/js/layout-Blog.7bc98592.js"><link rel="prefetch" href="/book/assets/js/layout-NotFound.59f7bf9f.js"><link rel="prefetch" href="/book/assets/js/layout-Slide.c68131e8.js"><link rel="prefetch" href="/book/assets/js/page--48099f42.a41838a3.js"><link rel="prefetch" href="/book/assets/js/page--6e038b40.18feb379.js"><link rel="prefetch" href="/book/assets/js/page-Home.6cc54e98.js"><link rel="prefetch" href="/book/assets/js/page-Spring集成smart-socket.d2624609.js"><link rel="prefetch" href="/book/assets/js/page-Summary.4a23975b.js"><link rel="prefetch" href="/book/assets/js/page-Websocket.cf41f05b.js"><link rel="prefetch" href="/book/assets/js/page-smart-socket.8dfe389f.js"><link rel="prefetch" href="/book/assets/js/page-smartboot.005efdd1.js"><link rel="prefetch" href="/book/assets/js/page-付费服务.4f550cb1.js"><link rel="prefetch" href="/book/assets/js/page-关于捐赠.47f6fb76.js"><link rel="prefetch" href="/book/assets/js/page-客户端AioQuickClient.b14f9330.js"><link rel="prefetch" href="/book/assets/js/page-小结.7ec45d6c.js"><link rel="prefetch" href="/book/assets/js/page-应用范围.e4ed32f1.js"><link rel="prefetch" href="/book/assets/js/page-快速上手.942b7b72.js"><link rel="prefetch" href="/book/assets/js/page-文件上传下载.bbcca7f7.js"><link rel="prefetch" href="/book/assets/js/page-服务端AioQuickServer.f6aebad4.js"><link rel="prefetch" href="/book/assets/js/page-核心接口与状态机.60c3f280.js"><link rel="prefetch" href="/book/assets/js/page-消息归类.00ecb954.js"><link rel="prefetch" href="/book/assets/js/page-第三章smart-socket源码解析.a48cb9e5.js"><link rel="prefetch" href="/book/assets/js/page-第三章通信协议.df9fee9e.js"><link rel="prefetch" href="/book/assets/js/page-请求路由.71975174.js"><link rel="prefetch" href="/book/assets/js/page-通信会话AioSession.fe40ba53.js"><link rel="prefetch" href="/book/assets/js/vendors~flowchart.0187c5e6.js"><link rel="prefetch" href="/book/assets/js/vendors~photo-swipe.7f2c8a6e.js"><link rel="prefetch" href="/book/assets/js/vendors~reveal.1c8d4140.js">
    <link rel="stylesheet" href="/book/assets/css/0.styles.b07082da.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container has-navbar has-sidebar has-anchor"><header class="navbar"><button class="sidebar-button"><span class="icon"></span></button> <a href="/book/" class="home-link router-link-active"><!----> <!----> <span class="site-name">SmartBoot</span></a> <div class="links"><button class="color-button"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="skin-icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4
        38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32
        51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0
        102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2
        6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4
        0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2
        9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224
        419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4
        470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0
        22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6
        12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128
        505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2
        16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8
        86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4
        80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6
        6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><ul class="themecolor-select"><label for="themecolor-select">Theme Color:</label> <li><a href="#" class="default-theme"></a></li> </ul> <div class="darkmode-toggle"><label for="darkmode-toggle" class="desc">Theme Mode:</label> <div class="darkmode-switch"><div class="item day"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon light-icon"><path d="M512 256a42.667 42.667 0 0042.667-42.667V128a42.667 42.667 0 00-85.334 0v85.333A42.667 42.667 0 00512 256zm384 213.333h-85.333a42.667 42.667 0 000 85.334H896a42.667 42.667 0 000-85.334zM256 512a42.667 42.667 0 00-42.667-42.667H128a42.667 42.667 0 000 85.334h85.333A42.667 42.667 0 00256 512zm9.387-298.667a42.667 42.667 0 00-59.307 62.72l61.44 59.307a42.667 42.667 0 0031.147 11.947 42.667 42.667 0 0030.72-13.227 42.667 42.667 0 000-60.16zm459.946 133.974a42.667 42.667 0 0029.44-11.947l61.44-59.307a42.667 42.667 0 00-57.6-62.72l-61.44 60.587a42.667 42.667 0 000 60.16 42.667 42.667 0 0028.16 13.227zM512 768a42.667 42.667 0 00-42.667 42.667V896a42.667 42.667 0 0085.334 0v-85.333A42.667 42.667 0 00512 768zm244.48-79.36a42.667 42.667 0 00-59.307 61.44l61.44 60.587a42.667 42.667 0 0029.44 11.946 42.667 42.667 0 0030.72-12.8 42.667 42.667 0 000-60.586zm-488.96 0l-61.44 59.307a42.667 42.667 0 000 60.586 42.667 42.667 0 0030.72 12.8 42.667 42.667 0 0028.587-10.666l61.44-59.307a42.667 42.667 0 00-59.307-61.44zM512 341.333A170.667 170.667 0 10682.667 512 170.667 170.667 0 00512 341.333z" fill="currentColor"></path></svg></div> <div class="item auto active"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon auto-icon"><path d="M460.864 539.072H564.8L510.592 376l-49.728 163.072zM872 362.368V149.504H659.648L510.528 0l-149.12 149.504H149.12v212.928L0 511.872l149.12 149.504v212.928h212.352l149.12 149.504 149.12-149.504h212.352V661.376l149.12-149.504L872 362.368zM614.464 693.12l-31.616-90.624H438.272l-31.616 90.624h-85.888l144.576-407.68h90.368l144.576 407.68h-85.824zm0 0" fill="currentColor"></path></svg></div> <div class="item night"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon dark-icon"><path d="M935.539 630.402c-11.43-11.432-28.674-14.739-43.531-8.354-46.734 20.103-96.363 30.297-147.508 30.297-99.59 0-193.221-38.784-263.64-109.203-108.637-108.637-139.61-270.022-78.908-411.148a39.497 39.497 0 00-51.886-51.887c-52.637 22.64-100.017 54.81-140.826 95.616-85.346 85.346-132.346 198.821-132.346 319.52 0 120.7 47.001 234.172 132.347 319.519S408.063 947.11 528.76 947.11c120.7 0 234.172-47.003 319.52-132.351 40.809-40.81 72.978-88.19 95.616-140.826a39.497 39.497 0 00-8.356-43.532z" fill="currentColor"></path></svg></div></div> <!----></div></div></div></button> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/book/" class="nav-link router-link-active"><i class="iconfont icon-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文档" class="dropdown-title"><span class="title"><i class="iconfont icon-info"></i>
      文档
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="文档" class="mobile-dropdown-title"><span class="title"><i class="iconfont icon-info"></i>
      文档
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/book/smart-socket/" class="nav-link router-link-active active"><!---->
  smart-socket
</a></li><li class="dropdown-item"><!----> <a href="/book/smart-http/" class="nav-link"><!---->
  smart-http
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="了解更多" class="dropdown-title"><span class="title"><!---->
      了解更多
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="了解更多" class="mobile-dropdown-title"><span class="title"><!---->
      了解更多
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/book/donation.html" class="nav-link"><!---->
  关于捐赠
</a></li><li class="dropdown-item"><!----> <a href="/book/service.html" class="nav-link"><!---->
  付费服务
</a></li><li class="dropdown-item"><h4>开源仓库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://gitee.com/smartboot" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://github.com/smartboot" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <nav class="nav-links"><div class="nav-item"><a href="/book/" class="nav-link router-link-active"><i class="iconfont icon-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文档" class="dropdown-title"><span class="title"><i class="iconfont icon-info"></i>
      文档
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="文档" class="mobile-dropdown-title"><span class="title"><i class="iconfont icon-info"></i>
      文档
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/book/smart-socket/" class="nav-link router-link-active active"><!---->
  smart-socket
</a></li><li class="dropdown-item"><!----> <a href="/book/smart-http/" class="nav-link"><!---->
  smart-http
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="了解更多" class="dropdown-title"><span class="title"><!---->
      了解更多
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="了解更多" class="mobile-dropdown-title"><span class="title"><!---->
      了解更多
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/book/donation.html" class="nav-link"><!---->
  关于捐赠
</a></li><li class="dropdown-item"><!----> <a href="/book/service.html" class="nav-link"><!---->
  付费服务
</a></li><li class="dropdown-item"><h4>开源仓库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://gitee.com/smartboot" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://github.com/smartboot" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/book/smart-socket/" aria-current="page" class="sidebar-link">smart-socket</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><!----> <span>指南</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/book/smart-socket/getting-started/" class="sidebar-link">快速上手</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/book/smart-socket/getting-started/#项目概要" class="sidebar-link">项目概要</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/book/smart-socket/getting-started/#项目优势" class="sidebar-link">项目优势</a></li><li class="sidebar-sub-header"><a href="/book/smart-socket/getting-started/#工程结构" class="sidebar-link">工程结构</a></li></ul></li><li class="sidebar-sub-header"><a href="/book/smart-socket/getting-started/#🛠-安装" class="sidebar-link">🛠 安装</a></li><li class="sidebar-sub-header"><a href="/book/smart-socket/getting-started/#🚀-使用" class="sidebar-link">🚀 使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/book/smart-socket/getting-started/#通信协议" class="sidebar-link">通信协议</a></li><li class="sidebar-sub-header"><a href="/book/smart-socket/getting-started/#服务端开发" class="sidebar-link">服务端开发</a></li><li class="sidebar-sub-header"><a href="/book/smart-socket/getting-started/#客户端开发" class="sidebar-link">客户端开发</a></li><li class="sidebar-sub-header"><a href="/book/smart-socket/getting-started/#启动运行" class="sidebar-link">启动运行</a></li></ul></li><li class="sidebar-sub-header"><a href="/book/smart-socket/getting-started/#最后" class="sidebar-link">最后</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><!----> <span>深入</span> <!----></p> <!----></section></li></ul> </aside> <main class="page"><nav class="breadcrumb"><ul><li><a href="/book/smart-socket/" class="router-link-active"><!---->
        smart-socket
      </a></li><li class="is-active"><a href="/book/smart-socket/chapter-5/" aria-current="page" class="router-link-exact-active router-link-active"><!---->
        第四章 内存池
      </a></li></ul></nav>  <div class="page-title"><h1><!---->
    第四章 内存池
  </h1> <div class="page-info"><!----> <!----><span aria-label="Page views🔢" data-balloon-pos="down" class="visitor-info"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon eye-icon"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 00-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z" fill="currentColor"></path></svg> <span id="/book/smart-socket/chapter-5/" data-flag-title="第四章 内存池" class="leancloud_visitors"><span class="leancloud-visitors-count">...</span></span></span><!----><!----><!----><span aria-label="Reading Time⌛" data-balloon-pos="down" class="read-time-info"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon time-icon"><path d="M511.997 70.568c-243.797 0-441.429 197.633-441.429 441.435 0 243.797 197.632 441.429 441.43 441.429S953.431 755.8 953.431 512.002c0-243.796-197.637-441.434-441.435-441.434zm150.158 609.093l-15.605 15.61c-8.621 8.615-22.596 8.615-31.215 0L472.197 552.126c-4.95-4.944-4.34-14.888-4.34-24.677V247.14c0-12.19 9.882-22.07 22.07-22.07h22.07c12.19 0 22.07 9.882 22.07 22.07v273.218l128.088 128.088c8.62 8.62 8.62 22.595 0 31.215zm0 0" fill="currentColor"></path></svg> <span>About 6 min</span></span></div> <hr></div> <!----> <div class="anchor-place-holder"><aside id="anchor"><div class="anchor-wrapper"><ul class="anchor-list"></ul></div></aside></div> <div class="theme-default-content content__default"><h1 id="第四章-内存池"><a href="#第四章-内存池" class="header-anchor">#</a> 第四章 内存池</h1> <p>内存池似乎已经当下各个牛逼框架的标配，我们也专门为smart-socket度身打造了一款内存池解决方案。当然我们并不是为了盲目跟风，确实是有一些问题需要通过该项技术得以解决，并且smart-socket的内存池表现非常令人满意。在此跟大家分享一下smart-socket内存池的设计理念，但愿能与读者朋友产生共鸣。</p> <p><strong>概念描述</strong></p> <ol><li>内存池：BufferPool<br>
一个内存池中包含了多个内存页<code>BufferPage</code>，为内存申请源提供内存页的分配策略，并且运行着低优先级异步任务将未使用的内存块<code>chunk</code>回收至内存页<code>BufferPage</code>。</li> <li>内存页：BufferPage<br>
其本质就是一个由用户指定大小的 ByteBuffer 对象，DirectByteBuffer 和 HeapByteBuffer 皆可。通过事先初始化足够大小的内存页，服务运行期间可快速响应内存需求。</li> <li>内存块：chunk<br>
从 BufferPage 中划分出来的小块内存以满足通信所需，内存块的的申请尽量遵循按需申请，用完即还原则。当内存页中剩余空间不足以满足申请源需求大小时，smart-socket 将向 JVM 申请临时内存块。</li></ol> <p>smart-socket引入内存池设计，主要为了解决两个问题：零拷贝、对象复用。</p> <ul><li><p>零拷贝；</p> <p>接触过Netty的朋友应该都听说过该项技术，这项技术的原理也很简单。在数据传输时，如果存储数据的ByteBuffer是堆内缓冲区对象HeapByteBuffer，则在输出时JVM会将该缓冲区的数据拷贝到堆外的直接缓冲区DirectByteBuffer再输出，该场景就存在一次内存拷贝。而如果一开始我们就将数据写入直接缓冲区DirectByteBuffer，则无需进行数据拷贝便可输出数据，这就是所谓的零拷贝，而零拷贝所带来的好处就是节省了临时内存和CPU的消耗，以下便是JVM执行数据输出的处理方式，阅读源码有助于读者朋友更深刻的理解零拷贝。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">write</span><span class="token punctuation">(</span><span class="token class-name">FileDescriptor</span> var0<span class="token punctuation">,</span> <span class="token class-name">ByteBuffer</span> var1<span class="token punctuation">,</span> <span class="token keyword">long</span> var2<span class="token punctuation">,</span> <span class="token class-name">NativeDispatcher</span> var4<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>var1 <span class="token keyword">instanceof</span> <span class="token class-name">DirectBuffer</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token function">writeFromNativeBuffer</span><span class="token punctuation">(</span>var0<span class="token punctuation">,</span> var1<span class="token punctuation">,</span> var2<span class="token punctuation">,</span> var4<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token keyword">int</span> var5 <span class="token operator">=</span> var1<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> var6 <span class="token operator">=</span> var1<span class="token punctuation">.</span><span class="token function">limit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">assert</span> var5 <span class="token operator">&lt;=</span> var6<span class="token punctuation">;</span>

            <span class="token keyword">int</span> var7 <span class="token operator">=</span> var5 <span class="token operator">&lt;=</span> var6 <span class="token operator">?</span> var6 <span class="token operator">-</span> var5 <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token class-name">ByteBuffer</span> var8 <span class="token operator">=</span> <span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">getTemporaryDirectBuffer</span><span class="token punctuation">(</span>var7<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">int</span> var10<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                var8<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>var1<span class="token punctuation">)</span><span class="token punctuation">;</span>
                var8<span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                var1<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>var5<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> var9 <span class="token operator">=</span> <span class="token function">writeFromNativeBuffer</span><span class="token punctuation">(</span>var0<span class="token punctuation">,</span> var8<span class="token punctuation">,</span> var2<span class="token punctuation">,</span> var4<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>var9 <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    var1<span class="token punctuation">.</span><span class="token function">position</span><span class="token punctuation">(</span>var5 <span class="token operator">+</span> var9<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                var10 <span class="token operator">=</span> var9<span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
                <span class="token class-name">Util</span><span class="token punctuation">.</span><span class="token function">offerFirstTemporaryDirectBuffer</span><span class="token punctuation">(</span>var8<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> var10<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div></li> <li><p>复用对象；</p> <p>实现对象的复用一方面可以节省对象构造造成的时间成本，另一方面可以大大减少运行过程中产生的对象数，缓解GC压力。特别对于直接缓冲区DirectByteBuffer对象，不仅创建耗时长，而且因其存在于堆外内存中导致无法通过垃圾回收器释放内存，非常适合通过池化管理提升对象复用率。</p></li></ul> <h2 id="_4-1-设计原理"><a href="#_4-1-设计原理" class="header-anchor">#</a> 4.1 设计原理</h2> <p>​	smart-socket内存池的设计原理比较简单，事先在堆外内存中申请一个大的DirectByteBuffer，后续使用时通过DirectByteBuffer映射出实际所需大小的虚拟Buffer于堆内空间中。所以这VirtualBuffer其实就是堆外内存在堆内内存中创建的一个索引，smart-socket在堆内空间中对VirtualBuffer的一切数据读写操作都会同步反应至堆外的DirectByteBuffer中。</p> <img src="docs/smart-socket/chapter-5/bufferpool_1.png" width="60%"> <center>图4-1-1</center> <p>接下来通过几张图示范一下内存池的运作流程。例如：</p> <ol><li><p>我们需要一块长度为2的ByteBuffer，那么我们就映射出一个VirtualBuffer占用堆外内存中的两个字节空间。</p></li> <li><p>之后我们还需要一块长度为4的ByteBuffer，那就只能申请下标3至6的空间。</p> <img src="docs/smart-socket/chapter-5/bufferpool_2.png" width="60%"> <center>图4-1-2</center></li> <li><p>当虚拟内存使用完毕后，要及时释放占用的堆外内存。</p> <img src="docs/smart-socket/chapter-5/bufferpool_3.png" width="60%"> <center>图4-1-3</center></li> <li><p>下一次再需要空间时继续从可用空间中申请。</p> <img src="docs/smart-socket/chapter-5/bufferpool_4.png" width="60%"></li></ol> <center>图4-1-4</center> <p>​	通过不断的申请、释放，smart-socket内存池便运转起来了。需要注意的事，内存的申请是从头到尾进行扫描，而释放回收是无时序的，如图4-1-4。所以在实际运行中会产生一些不连续的小内存块，也就是内存碎片。内存碎片化是个必然存在的状况，假如这种小颗粒内存碎片占比增高，会降低虚拟内存申请的成功率。如果虚拟内存申请失败，smart-socket内存池会启用备用方案,采用申请堆内缓冲区的方式满足应用所需，此类缓冲区使用完毕后可由垃圾回收器释放。这样一种堆外为主，堆内为辅的设计方案，保障了smart-socket内存池的稳定、高效。</p> <h2 id="_4-2-内存池实践"><a href="#_4-2-内存池实践" class="header-anchor">#</a> 4.2 内存池实践</h2> <p>​	前文讲完了smart-socket内存池的设计原理，但在实践中还会面临一个情况，便是内存分配、回收时面临的并发问题。尽管只需加同步锁控便能解决，但是在高并发场景下的锁竞争会比较激烈，为了缓解这一状况。smart-socket内存池中引入了内存页BufferPage的概念。内存池中创建一组BufferPage，每个BufferPage各自封装一个大的DirectByteBuffer。再根据特定的分配策略将网络会话AIOSession与某个BufferPage关联起来，由此降低并发情况下的锁竞争压力。</p> <img src="docs/smart-socket/chapter-5/bufferpage_1.png" width="100%"> <p>​	最终我们的smart-socket内存池实现如下所示。初始化内存池时需要指定内存页的个数，为每个内存页分配的空间大小，以及是否使用直接缓冲区。至于内存页的分配，采用的是轮训策略。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BufferPagePool</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">BufferPage</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bufferPageList<span class="token punctuation">;</span>
    <span class="token comment">/**
     * 内存页游标
     */</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> cursor <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * @param pageSize 内存页大小
     * @param poolSize 内存页个数
     * @param isDirect 是否使用直接缓冲区
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">BufferPagePool</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token keyword">int</span> pageSize<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">int</span> poolSize<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token keyword">boolean</span> isDirect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        bufferPageList <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferPage</span><span class="token punctuation">[</span>poolSize<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> poolSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            bufferPageList<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BufferPage</span><span class="token punctuation">(</span>pageSize<span class="token punctuation">,</span> isDirect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 申请内存页
     *
     * @return
     */</span>
    <span class="token keyword">public</span> <span class="token class-name">BufferPage</span> <span class="token function">allocateBufferPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//轮训游标，均衡分配内存页</span>
        cursor <span class="token operator">=</span> <span class="token punctuation">(</span>cursor <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">%</span> bufferPageList<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
        <span class="token class-name">BufferPage</span> page <span class="token operator">=</span> bufferPageList<span class="token punctuation">[</span>cursor<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> page<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><h2 id="_4-3-总结"><a href="#_4-3-总结" class="header-anchor">#</a> 4.3 总结</h2> <p>​	smart-socket内存池的设计可能在理论层面的探讨会更有意义，它所带来的性能提升和内存优化，很轻易的就会被实际业务场景下的系统业务抵消掉。而smart-socket花费大量精力设计的内存池，是为了达到实验室环境下的最优解。框架层面做的每一次努力，都是期望让更多的硬件资源服务于用户的业务，提升资源利用率。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last update:</span> <span class="time">February 25, 2021 12:31</span></div></footer> <!----> <!----> </main> <!----></div><div class="global-ui"><!----><!----><div id="pwa-install"><!----> <div id="install-modal-wrapper" style="display:none;"><div class="background"></div> <div class="install-modal"><div class="header"><button aria-label="Close" class="close-button"><svg width="23" height="22" xmlns="http://www.w3.org/2000/svg" class="icon close-icon"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.12.358a1.224 1.224 0 011.729 0l8.92 8.914L20.686.358a1.224 1.224 0 011.73 1.728L13.497 11l8.92 8.913a1.222 1.222 0 11-1.73 1.729l-8.919-8.913-8.92 8.913a1.224 1.224 0 01-1.729-1.729L10.04 11l-8.92-8.914a1.222 1.222 0 010-1.728z" fill="currentColor"></path></svg></button> <div class="logo"><!----> <div class="title"><h1></h1> <p class="desc">This app can be installed on your PC or mobile device.  This will allow this web app to look and behave like any other installed app.  You will find it in your app lists and be able to pin it to your home screen, start menus or task bars.  This installed web app will also be able to safely interact with other apps and your operating system. </p></div></div></div> <div class="content"><div class="highlight"><!----> <!----></div> <div class="description"><h3>Description</h3> <p></p></div></div> <div class="button-wrapper"><button class="install-button">
        Install <span></span></button> <button class="cancel-button">
        Cancel
      </button></div></div></div></div><div tabindex="-1" role="dialog" aria-hidden="true" class="pswp"><div class="pswp__bg"></div> <div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div> <div class="pswp__item"></div> <div class="pswp__item"></div></div> <div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button title="Close (Esc)" class="pswp__button pswp__button--close"></button> <button title="Share" class="pswp__button pswp__button--share"></button> <button title="Toggle fullscreen" class="pswp__button pswp__button--fs"></button> <button title="Zoom in/out" class="pswp__button pswp__button--zoom"></button> <div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div> <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button title="Previous (arrow left)" class="pswp__button pswp__button--arrow--left"></button> <button title="Next (arrow right)" class="pswp__button pswp__button--arrow--right"></button> <div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div></div></div>
    <script src="/book/assets/js/app.6eb622a1.js" defer></script><script src="/book/assets/js/layout-Layout.6827866a.js" defer></script><script src="/book/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.ac8a61b1.js" defer></script><script src="/book/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-Slide.2a107b58.js" defer></script><script src="/book/assets/js/vendors~layout-Blog~layout-Layout.4f275bc9.js" defer></script><script src="/book/assets/js/page-第四章内存池.4f602f0e.js" defer></script>
  </body>
</html>
