<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>核心接口与状态机 | SmartBoot</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="img.png">
    <link rel="manifest" href="/book/manifest.webmanifest" crossorigin="use-credentials">
    <meta name="description" content="">
    <meta property="og:url" content="/book/smart-socket/chapter-2/Interface/">
    <meta property="og:site_name" content="SmartBoot">
    <meta property="og:title" content="核心接口与状态机">
    <meta property="og:type" content="article">
    <meta property="og:locale" content="en-US">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image:alt" content="SmartBoot">
    <meta name="theme-color" content="#46bd87">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <link rel="preload" href="/book/assets/css/0.styles.f592dd15.css" as="style"><link rel="preload" href="/book/assets/js/app.df6b423f.js" as="script"><link rel="preload" href="/book/assets/js/layout-Layout.508f32ad.js" as="script"><link rel="preload" href="/book/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.2b3b4a8c.js" as="script"><link rel="preload" href="/book/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-Slide.2a107b58.js" as="script"><link rel="preload" href="/book/assets/js/vendors~layout-Blog~layout-Layout.92da2f08.js" as="script"><link rel="preload" href="/book/assets/js/page-核心接口与状态机.efb4d839.js" as="script"><link rel="prefetch" href="/book/assets/js/40.111678b4.js"><link rel="prefetch" href="/book/assets/js/41.5167ea6d.js"><link rel="prefetch" href="/book/assets/js/42.34a61149.js"><link rel="prefetch" href="/book/assets/js/43.e5a150e2.js"><link rel="prefetch" href="/book/assets/js/44.a5853ef3.js"><link rel="prefetch" href="/book/assets/js/layout-Blog.ee2fabc0.js"><link rel="prefetch" href="/book/assets/js/layout-NotFound.46064718.js"><link rel="prefetch" href="/book/assets/js/layout-Slide.f61267c3.js"><link rel="prefetch" href="/book/assets/js/page--48099f42.5c06a562.js"><link rel="prefetch" href="/book/assets/js/page--6e038b40.e8c32d25.js"><link rel="prefetch" href="/book/assets/js/page-Home.db4fc45b.js"><link rel="prefetch" href="/book/assets/js/page-Spring集成.4833895a.js"><link rel="prefetch" href="/book/assets/js/page-Summary.16648730.js"><link rel="prefetch" href="/book/assets/js/page-Websocket.73ae07f4.js"><link rel="prefetch" href="/book/assets/js/page-smart-im.4c9c25b1.js"><link rel="prefetch" href="/book/assets/js/page-smart-socket.2075ff48.js"><link rel="prefetch" href="/book/assets/js/page-smartboot.c98c5f3c.js"><link rel="prefetch" href="/book/assets/js/page-付费服务.61a9eba7.js"><link rel="prefetch" href="/book/assets/js/page-关于smart-socket.94078d52.js"><link rel="prefetch" href="/book/assets/js/page-关于捐赠.ff566e11.js"><link rel="prefetch" href="/book/assets/js/page-客户端AioQuickClient.5c44752b.js"><link rel="prefetch" href="/book/assets/js/page-小结.ab747cd3.js"><link rel="prefetch" href="/book/assets/js/page-开发团队.8a16be92.js"><link rel="prefetch" href="/book/assets/js/page-开源众筹.8100b0a6.js"><link rel="prefetch" href="/book/assets/js/page-快速上手.1ebd8b32.js"><link rel="prefetch" href="/book/assets/js/page-插件清单.56361b36.js"><link rel="prefetch" href="/book/assets/js/page-文件上传下载.c6494660.js"><link rel="prefetch" href="/book/assets/js/page-服务端AioQuickServer.2e627f0a.js"><link rel="prefetch" href="/book/assets/js/page-消息归类.7894057d.js"><link rel="prefetch" href="/book/assets/js/page-第三章smart-socket源码解析.12266091.js"><link rel="prefetch" href="/book/assets/js/page-第三章通信协议.cee085b4.js"><link rel="prefetch" href="/book/assets/js/page-第四章内存池.31e8fc5d.js"><link rel="prefetch" href="/book/assets/js/page-评测数据.afca7e44.js"><link rel="prefetch" href="/book/assets/js/page-请求路由.7b9a856e.js"><link rel="prefetch" href="/book/assets/js/page-通信会话AioSession.640b14c6.js"><link rel="prefetch" href="/book/assets/js/vendors~flowchart.0244e11d.js"><link rel="prefetch" href="/book/assets/js/vendors~photo-swipe.0048f927.js"><link rel="prefetch" href="/book/assets/js/vendors~reveal.320ee651.js">
    <link rel="stylesheet" href="/book/assets/css/0.styles.f592dd15.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container has-navbar has-sidebar has-anchor"><header class="navbar"><button class="sidebar-button"><span class="icon"></span></button> <a href="/book/" class="home-link router-link-active"><!----> <!----> <span class="site-name">SmartBoot</span></a> <div class="links"><button class="color-button"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="skin-icon"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4
        38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32
        51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0
        102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2
        6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4
        0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2
        9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224
        419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4
        470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0
        22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6
        12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128
        505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2
        16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8
        86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4
        80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6
        6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></svg> <div class="color-picker-menu" style="display:none;"><div class="theme-options"><ul class="themecolor-select"><label for="themecolor-select">Theme Color:</label> <li><a href="#" class="default-theme"></a></li> </ul> <div class="darkmode-toggle"><label for="darkmode-toggle" class="desc">Theme Mode:</label> <div class="darkmode-switch"><div class="item day"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon light-icon"><path d="M512 256a42.667 42.667 0 0042.667-42.667V128a42.667 42.667 0 00-85.334 0v85.333A42.667 42.667 0 00512 256zm384 213.333h-85.333a42.667 42.667 0 000 85.334H896a42.667 42.667 0 000-85.334zM256 512a42.667 42.667 0 00-42.667-42.667H128a42.667 42.667 0 000 85.334h85.333A42.667 42.667 0 00256 512zm9.387-298.667a42.667 42.667 0 00-59.307 62.72l61.44 59.307a42.667 42.667 0 0031.147 11.947 42.667 42.667 0 0030.72-13.227 42.667 42.667 0 000-60.16zm459.946 133.974a42.667 42.667 0 0029.44-11.947l61.44-59.307a42.667 42.667 0 00-57.6-62.72l-61.44 60.587a42.667 42.667 0 000 60.16 42.667 42.667 0 0028.16 13.227zM512 768a42.667 42.667 0 00-42.667 42.667V896a42.667 42.667 0 0085.334 0v-85.333A42.667 42.667 0 00512 768zm244.48-79.36a42.667 42.667 0 00-59.307 61.44l61.44 60.587a42.667 42.667 0 0029.44 11.946 42.667 42.667 0 0030.72-12.8 42.667 42.667 0 000-60.586zm-488.96 0l-61.44 59.307a42.667 42.667 0 000 60.586 42.667 42.667 0 0030.72 12.8 42.667 42.667 0 0028.587-10.666l61.44-59.307a42.667 42.667 0 00-59.307-61.44zM512 341.333A170.667 170.667 0 10682.667 512 170.667 170.667 0 00512 341.333z" fill="currentColor"></path></svg></div> <div class="item auto active"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon auto-icon"><path d="M460.864 539.072H564.8L510.592 376l-49.728 163.072zM872 362.368V149.504H659.648L510.528 0l-149.12 149.504H149.12v212.928L0 511.872l149.12 149.504v212.928h212.352l149.12 149.504 149.12-149.504h212.352V661.376l149.12-149.504L872 362.368zM614.464 693.12l-31.616-90.624H438.272l-31.616 90.624h-85.888l144.576-407.68h90.368l144.576 407.68h-85.824zm0 0" fill="currentColor"></path></svg></div> <div class="item night"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon dark-icon"><path d="M935.539 630.402c-11.43-11.432-28.674-14.739-43.531-8.354-46.734 20.103-96.363 30.297-147.508 30.297-99.59 0-193.221-38.784-263.64-109.203-108.637-108.637-139.61-270.022-78.908-411.148a39.497 39.497 0 00-51.886-51.887c-52.637 22.64-100.017 54.81-140.826 95.616-85.346 85.346-132.346 198.821-132.346 319.52 0 120.7 47.001 234.172 132.347 319.519S408.063 947.11 528.76 947.11c120.7 0 234.172-47.003 319.52-132.351 40.809-40.81 72.978-88.19 95.616-140.826a39.497 39.497 0 00-8.356-43.532z" fill="currentColor"></path></svg></div></div> <!----></div></div></div></button> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/book/" class="nav-link router-link-active"><i class="iconfont icon-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文档" class="dropdown-title"><span class="title"><i class="iconfont icon-info"></i>
      文档
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="文档" class="mobile-dropdown-title"><span class="title"><i class="iconfont icon-info"></i>
      文档
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/book/smart-socket/" class="nav-link router-link-active active"><!---->
  smart-socket
</a></li><li class="dropdown-item"><!----> <a href="/book/smart-http/" class="nav-link"><!---->
  smart-http
</a></li><li class="dropdown-item"><!----> <a href="/book/smart-servlet/" class="nav-link"><!---->
  smart-servlet
</a></li></ul></div></div><div class="nav-item"><a href="/book/members.html" class="nav-link"><i class="iconfont icon-home"></i>
  开发团队
</a></div><div class="nav-item"><a href="/book/crowdfunding.html" class="nav-link"><i class="iconfont icon-home"></i>
  开源众筹
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="了解更多" class="dropdown-title"><span class="title"><!---->
      了解更多
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="了解更多" class="mobile-dropdown-title"><span class="title"><!---->
      了解更多
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/book/donation.html" class="nav-link"><!---->
  关于捐赠
</a></li><li class="dropdown-item"><!----> <a href="/book/service.html" class="nav-link"><!---->
  付费服务
</a></li><li class="dropdown-item"><h4>开源仓库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://gitee.com/smartboot" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://github.com/smartboot" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <nav class="nav-links"><div class="nav-item"><a href="/book/" class="nav-link router-link-active"><i class="iconfont icon-home"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="文档" class="dropdown-title"><span class="title"><i class="iconfont icon-info"></i>
      文档
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="文档" class="mobile-dropdown-title"><span class="title"><i class="iconfont icon-info"></i>
      文档
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/book/smart-socket/" class="nav-link router-link-active active"><!---->
  smart-socket
</a></li><li class="dropdown-item"><!----> <a href="/book/smart-http/" class="nav-link"><!---->
  smart-http
</a></li><li class="dropdown-item"><!----> <a href="/book/smart-servlet/" class="nav-link"><!---->
  smart-servlet
</a></li></ul></div></div><div class="nav-item"><a href="/book/members.html" class="nav-link"><i class="iconfont icon-home"></i>
  开发团队
</a></div><div class="nav-item"><a href="/book/crowdfunding.html" class="nav-link"><i class="iconfont icon-home"></i>
  开源众筹
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="了解更多" class="dropdown-title"><span class="title"><!---->
      了解更多
    </span> <span class="arrow down"></span></button> <button type="button" aria-label="了解更多" class="mobile-dropdown-title"><span class="title"><!---->
      了解更多
    </span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/book/donation.html" class="nav-link"><!---->
  关于捐赠
</a></li><li class="dropdown-item"><!----> <a href="/book/service.html" class="nav-link"><!---->
  付费服务
</a></li><li class="dropdown-item"><h4>开源仓库</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="https://gitee.com/smartboot" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-subitem"><a href="https://github.com/smartboot" target="_blank" rel="noopener noreferrer" class="nav-link external"><!---->
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/book/smart-socket/" aria-current="page" class="sidebar-link">smart-socket</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><!----> <span>指南</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/book/smart-socket/getting-started/" class="sidebar-link">快速上手</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/book/smart-socket/getting-started/#项目简介" class="sidebar-link">🚚 项目简介</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/book/smart-socket/getting-started/#项目优势" class="sidebar-link">项目优势</a></li><li class="sidebar-sub-header"><a href="/book/smart-socket/getting-started/#工程结构" class="sidebar-link">工程结构</a></li></ul></li><li class="sidebar-sub-header"><a href="/book/smart-socket/getting-started/#🛠-安装" class="sidebar-link">🛠 安装</a></li><li class="sidebar-sub-header"><a href="/book/smart-socket/getting-started/#🚀-使用" class="sidebar-link">🚀 使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/book/smart-socket/getting-started/#通信协议" class="sidebar-link">通信协议</a></li><li class="sidebar-sub-header"><a href="/book/smart-socket/getting-started/#服务端-客户端开发" class="sidebar-link">服务端/客户端开发</a></li></ul></li></ul></li><li><a href="/book/smart-socket/spring-integrated/" class="sidebar-link">Spring 集成</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/book/smart-socket/spring-integrated/#方式一-xml配置化启动服务" class="sidebar-link">方式一：xml配置化启动服务</a></li><li class="sidebar-sub-header"><a href="/book/smart-socket/spring-integrated/#方式二-注解方式启动服务" class="sidebar-link">方式二：注解方式启动服务</a></li><li class="sidebar-sub-header"><a href="/book/smart-socket/spring-integrated/#最后" class="sidebar-link">最后</a></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><!----> <span>深入</span> <!----></p> <!----></section></li></ul> </aside> <main class="page"><nav class="breadcrumb"><ul><li><a href="/book/smart-socket/" class="router-link-active"><!---->
        smart-socket
      </a></li><li><a href="/book/smart-socket/chapter-2/" class="router-link-active"><!---->
        第三章 smart-socket源码解析
      </a></li><li class="is-active"><a href="/book/smart-socket/chapter-2/Interface/" aria-current="page" class="router-link-exact-active router-link-active"><!---->
        核心接口与状态机
      </a></li></ul></nav>  <div class="page-title"><h1><!---->
    核心接口与状态机
  </h1> <div class="page-info"><!----> <!----><span aria-label="Page views🔢" data-balloon-pos="down" class="visitor-info"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon eye-icon"><path d="M992 512.096c0-5.76-.992-10.592-1.28-11.136-.192-2.88-1.152-8.064-2.08-10.816-.256-.672-.544-1.376-.832-2.08-.48-1.568-1.024-3.104-1.6-4.32C897.664 290.112 707.104 160 512 160c-195.072 0-385.632 130.016-473.76 322.592-1.056 2.112-1.792 4.096-2.272 5.856a55.512 55.512 0 00-.64 1.6c-1.76 5.088-1.792 8.64-1.632 7.744-.832 3.744-1.568 11.168-1.568 11.168-.224 2.272-.224 4.032.032 6.304 0 0 .736 6.464 1.088 7.808.128 1.824.576 4.512 1.12 6.976h-.032c.448 2.08 1.12 4.096 1.984 6.08.48 1.536.992 2.976 1.472 4.032C126.432 733.856 316.992 864 512 864c195.136 0 385.696-130.048 473.216-321.696 1.376-2.496 2.24-4.832 2.848-6.912.256-.608.48-1.184.672-1.728 1.536-4.48 1.856-8.32 1.728-8.32l-.032.032c.608-3.104 1.568-7.744 1.568-13.28zM512 672c-88.224 0-160-71.776-160-160s71.776-160 160-160 160 71.776 160 160-71.776 160-160 160z" fill="currentColor"></path></svg> <span id="/book/smart-socket/chapter-2/Interface/" data-flag-title="核心接口与状态机" class="leancloud_visitors"><span class="leancloud-visitors-count">...</span></span></span><!----><!----><!----><span aria-label="Reading Time⌛" data-balloon-pos="down" class="read-time-info"><svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg" class="icon time-icon"><path d="M511.997 70.568c-243.797 0-441.429 197.633-441.429 441.435 0 243.797 197.632 441.429 441.43 441.429S953.431 755.8 953.431 512.002c0-243.796-197.637-441.434-441.435-441.434zm150.158 609.093l-15.605 15.61c-8.621 8.615-22.596 8.615-31.215 0L472.197 552.126c-4.95-4.944-4.34-14.888-4.34-24.677V247.14c0-12.19 9.882-22.07 22.07-22.07h22.07c12.19 0 22.07 9.882 22.07 22.07v273.218l128.088 128.088c8.62 8.62 8.62 22.595 0 31.215zm0 0" fill="currentColor"></path></svg> <span>About 5 min</span></span></div> <hr></div> <!----> <div class="anchor-place-holder"><aside id="anchor"><div class="anchor-wrapper"><ul class="anchor-list"></ul></div></aside></div> <div class="theme-default-content content__default"><h2 id="核心接口与状态机"><a href="#核心接口与状态机" class="header-anchor">#</a> 核心接口与状态机</h2> <p>业界有句话叫“一流的卖标准、二流的卖技术、三流的卖产品”，如果说 smart-socket 的技术价值仅算二流水准的话，那么我们为其精心设计的接口期望能稍微提升一下它的档次。</p> <p>smart-socket的学习成本主要集中在两个接口<code>Protocol</code>、<code>MessageProcessor</code>和一个状态机<code>StateMachineEnum</code>。
接口定义了数据处理规则，而状态机则是事件一种通知机制。</p> <p>###一、核心接口
这两个核心接口在通信流程中的职责如下：</p> <ul><li>Protocol：负责解析网络中传输过来的字节流，将其转换成消息实体，并传递至 MessageProcessor 进行业务处理。</li> <li>MessageProcessor：处理接受到的网络消息，并在必要时候输出消息至对端。
<img src="docs/smart-socket/chapter-2/Interface/core-api.png" alt=""></li></ul> <p>当然，你也可以在 Protocol 中一次性完成解析、业务处理；
又或者将 Protocol 当个摆设，所有事情集中在 MessageProcessor 完成。
smart-socket 不限制你实现功能的自由性，只是提供一个更规范、更合理的建议，最终决定权还是在用户的手中。</p> <h4 id="protocol"><a href="#protocol" class="header-anchor">#</a> Protocol</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Protocol</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token class-name">T</span> <span class="token function">decode</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ByteBuffer</span> readBuffer<span class="token punctuation">,</span> <span class="token class-name">AioSession</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> session<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>Protocol 是一个泛型接口，<code>&lt;T&gt;</code>指的是业务消息实体类，smart-socket 中不少地方都运用了泛型设计，其含义都代表数据解码后封装的消息类型。</p> <p>decode（消息解码），AIO 的数据传输是以 ByteBuffer 为媒介的。所有读取到的字节数据都会填充在 ByteBuffer 中并以事件回调的形式触发 Protocol#decode() 方法。所以我们实现的 decode 算法就是 ByteBuffer 对象转化为业务消息<code>&lt;T&gt;</code>的过程。</p> <p>需要强调一点，读者朋友请不要把解码想的很简单，令人“深恶痛绝”的半包/粘包就是在这个环节需要应对的。
大家不要寄希望于框架自动解决半包/粘包问题，因为这个问题的解决是靠你的解码算法去做容错的。
如果哪个框架宣称解决了此问题，那边通常有两种情况：</p> <ol><li>你所需的协议是由该框架提供的，它的解码算法确实能兼容了半包/粘包情况。</li> <li>框架提供了一种宽松内存策略，确保你能接受到一个完整的包。</li></ol> <p>无论何种情况，对个人而言都不是一件好事。
在你没有理解半包/粘包的出现场景和应对策略之前，过渡依赖框架的只会限制你对通信的认知，也会增加与内行人士的沟通难道。</p> <h4 id="messageprocessor"><a href="#messageprocessor" class="header-anchor">#</a> MessageProcessor</h4> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">MessageProcessor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>

    <span class="token comment">/**
     * 处理接收到的消息
     *
     * @param session 通信会话
     * @param msg     待处理的业务消息
     */</span>
    <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">AioSession</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> session<span class="token punctuation">,</span> <span class="token class-name">T</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 状态机事件,当枚举事件发生时由框架触发该方法
     *
     *
     * @param session          本次触发状态机的AioSession对象
     * @param stateMachineEnum 状态枚举
     * @param throwable        异常对象，如果存在的话
     * @see StateMachineEnum
     */</span>
    <span class="token keyword">void</span> <span class="token function">stateEvent</span><span class="token punctuation">(</span><span class="token class-name">AioSession</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> session<span class="token punctuation">,</span> <span class="token class-name">StateMachineEnum</span> stateMachineEnum<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><p>smart-socket 在通过 Protocol 完成消息解码后，会将消息对象交由 MessageProcessor 实现类进行业务处理。</p> <ul><li>process
消息处理器，smart-socket 每接收到一个完整的业务消息，都会交由该处理器执行。</li> <li>stateEvent
执行状态机，smart-socket 内置了状态枚举<code>StateMachineEnum</code>。<code>MessageProcessor</code>实现类可在此方法中处理其关注的事件。</li></ul> <h3 id="状态机statemachineenum"><a href="#状态机statemachineenum" class="header-anchor">#</a> 状态机StateMachineEnum</h3> <p>smart-socket 中引入了状态机的概念，状态机的存在不会决策 smart-socket 对于通信的事件处理，但会在特定事件发生之时通知消息处理器<code>MessageProcessor#stateEvent</code>。目前已有的状态枚举为：</p> <table><thead><tr><th>状态枚举</th> <th>说明</th></tr></thead> <tbody><tr><td>NEW_SESSION</td> <td>网络连接建立时触发，连接建立时会构建传输层的AioSession，如果业务层面也需要维护一个会话，可在此状态机中处理</td></tr> <tr><td>INPUT_SHUTDOWN</td> <td>数据读取完毕时触发，即传统意义中的<code>read()==-1</code></td></tr> <tr><td>INPUT_EXCEPTION</td> <td>读数据过程中发生异常时触发此状态机</td></tr> <tr><td>OUTPUT_EXCEPTION</td> <td>写数据过程中发生异常时触发此状态机</td></tr> <tr><td>SESSION_CLOSING</td> <td>触发了AioSession.close方法，但由于当前AioSession还有未完成的事件，会进入SESSION_CLOSING状态</td></tr> <tr><td>SESSION_CLOSED</td> <td>AioSesson完成close操作后触发此状态机</td></tr> <tr><td>PROCESS_EXCEPTION</td> <td>业务处理异常</td></tr> <tr><td>DECODE_EXCEPTION</td> <td>解码异常</td></tr> <tr><td>REJECT_ACCEPT</td> <td>服务端拒绝客户端连接请求</td></tr></tbody></table> <p>状态机贯穿了通信服务的整个生命周期，在这个过程中不同事件的发生会触发不同的状态机。通信事件与状态机的关系如下图所示。</p> <img src="docs/smart-socket/chapter-2/Interface/2.2.2_1.png" width="90%"> <center>图2.2.2</center> <p>状态机相对于整个通信环境的各个节点只是一个旁观者，它见证了各个事件的发生，却无力扭转事件的发展方向。</p> <p>状态机的本质跟大家所认知的过滤器、拦截器有点类似，那为什么smart-socket要如此设计呢？想想一下如果我们按照过滤器的设计思路，其形态会如下所示：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">interface</span> <span class="token class-name">Filter</span><span class="token punctuation">{</span>
    <span class="token keyword">void</span> <span class="token function">newSession</span><span class="token punctuation">(</span><span class="token class-name">AioSesion</span> session<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">processException</span><span class="token punctuation">(</span><span class="token class-name">AioSession</span> session<span class="token punctuation">,</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">decodeExcepton</span><span class="token punctuation">(</span><span class="token class-name">AioSession</span> session<span class="token punctuation">,</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">inputException</span><span class="token punctuation">(</span><span class="token class-name">AioSession</span> session<span class="token punctuation">,</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">outputException</span><span class="token punctuation">(</span><span class="token class-name">AioSession</span> session<span class="token punctuation">,</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">sessionClosing</span><span class="token punctuation">(</span><span class="token class-name">AioSession</span> session<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">void</span> <span class="token function">sessionClosed</span><span class="token punctuation">(</span><span class="token class-name">AioSession</span> session<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>这样的设计存在以下缺陷：</p> <ol><li>对实现类不友好；也许我只想处理 newSession，却不得不保留其余方法的空实现；</li> <li>无法平滑升级；加入新版本中加入新的事件类型，老版本代码需要全部更改；</li></ol> <p>而采用状态机模式，不仅解决了上述问题，还为通信服务的多元化扩展带了便利。
例如 IM 场景下，我们在 NEW_SESSION 状态机中收集 Session 集合，在消息处理时很容易就能实现消息群发；
当某个用户断线后，我们及时在状态机 SESSION_CLOSED 中感知到并更新 Session 集合中的会话状态，甚至可以群发消息给所有用户“某某人掉线了”。这些通信状态和业务相结合的场景， 用状态机能很好的得以解决。最后奉上一段粗糙的伪代码，读者自行领悟。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">IMProcessor</span> <span class="token keyword">implements</span> <span class="token class-name">MessageProcessor</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">LinkedBlockingQueue</span> sessions <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">LinkedBlockingQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">process</span><span class="token punctuation">(</span><span class="token class-name">AioSession</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> session<span class="token punctuation">,</span> <span class="token class-name">Message</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">AioSession</span> otherSession<span class="token operator">:</span>sessions<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>otherSession<span class="token operator">==</span>session<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">sendMessage</span><span class="token punctuation">(</span>otherSession<span class="token punctuation">,</span>session<span class="token operator">+</span><span class="token string">&quot;群发送消息：&quot;</span><span class="token operator">+</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">stateEvent</span><span class="token punctuation">(</span><span class="token class-name">AioSession</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Message</span><span class="token punctuation">&gt;</span></span> session<span class="token punctuation">,</span> <span class="token class-name">StateMachineEnum</span> state<span class="token punctuation">,</span> <span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>state<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> NEW_SESSION<span class="token operator">:</span>
                sessions<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> SESSION_CLOSED<span class="token operator">:</span>
                sessions<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br></div></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last update:</span> <span class="time">February 25, 2021 12:31</span></div></footer> <!----> <!----> </main> <!----></div><div class="global-ui"><!----><!----><div id="pwa-install"><!----> <div id="install-modal-wrapper" style="display:none;"><div class="background"></div> <div class="install-modal"><div class="header"><button aria-label="Close" class="close-button"><svg width="23" height="22" xmlns="http://www.w3.org/2000/svg" class="icon close-icon"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.12.358a1.224 1.224 0 011.729 0l8.92 8.914L20.686.358a1.224 1.224 0 011.73 1.728L13.497 11l8.92 8.913a1.222 1.222 0 11-1.73 1.729l-8.919-8.913-8.92 8.913a1.224 1.224 0 01-1.729-1.729L10.04 11l-8.92-8.914a1.222 1.222 0 010-1.728z" fill="currentColor"></path></svg></button> <div class="logo"><!----> <div class="title"><h1></h1> <p class="desc">This app can be installed on your PC or mobile device.  This will allow this web app to look and behave like any other installed app.  You will find it in your app lists and be able to pin it to your home screen, start menus or task bars.  This installed web app will also be able to safely interact with other apps and your operating system. </p></div></div></div> <div class="content"><div class="highlight"><!----> <!----></div> <div class="description"><h3>Description</h3> <p></p></div></div> <div class="button-wrapper"><button class="install-button">
        Install <span></span></button> <button class="cancel-button">
        Cancel
      </button></div></div></div></div><div tabindex="-1" role="dialog" aria-hidden="true" class="pswp"><div class="pswp__bg"></div> <div class="pswp__scroll-wrap"><div class="pswp__container"><div class="pswp__item"></div> <div class="pswp__item"></div> <div class="pswp__item"></div></div> <div class="pswp__ui pswp__ui--hidden"><div class="pswp__top-bar"><div class="pswp__counter"></div> <button title="Close (Esc)" class="pswp__button pswp__button--close"></button> <button title="Share" class="pswp__button pswp__button--share"></button> <button title="Toggle fullscreen" class="pswp__button pswp__button--fs"></button> <button title="Zoom in/out" class="pswp__button pswp__button--zoom"></button> <div class="pswp__preloader"><div class="pswp__preloader__icn"><div class="pswp__preloader__cut"><div class="pswp__preloader__donut"></div></div></div></div></div> <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class="pswp__share-tooltip"></div></div> <button title="Previous (arrow left)" class="pswp__button pswp__button--arrow--left"></button> <button title="Next (arrow right)" class="pswp__button pswp__button--arrow--right"></button> <div class="pswp__caption"><div class="pswp__caption__center"></div></div></div></div></div></div></div>
    <script src="/book/assets/js/app.df6b423f.js" defer></script><script src="/book/assets/js/layout-Layout.508f32ad.js" defer></script><script src="/book/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound.2b3b4a8c.js" defer></script><script src="/book/assets/js/vendors~layout-Blog~layout-Layout~layout-NotFound~layout-Slide.2a107b58.js" defer></script><script src="/book/assets/js/vendors~layout-Blog~layout-Layout.92da2f08.js" defer></script><script src="/book/assets/js/page-核心接口与状态机.efb4d839.js" defer></script>
  </body>
</html>
