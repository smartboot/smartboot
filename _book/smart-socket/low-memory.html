<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>3.低内存模式 | smartboot 开源组织</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <meta name="description" content="smartboot 旗下开源项目文档，我们开源项目包括支持百万级长连接的国产Java AIO 通信框架smart-socket、http服务器，servlet容器">
    <meta name="keywords" content="smartboot,smart-socket,smart-http,smart-servlet,百万级长连接">
    <meta name="theme-color" content="#11a8cd">
    <meta name="baidu-site-verification" content="code-j1XZ46JIBR">
    
    <link rel="preload" href="/assets/css/0.styles.534af037.css" as="style"><link rel="preload" href="/assets/js/app.b29c3e4e.js" as="script"><link rel="preload" href="/assets/js/2.16896ec1.js" as="script"><link rel="preload" href="/assets/js/13.60f68db7.js" as="script"><link rel="prefetch" href="/assets/js/10.bd5e04e4.js"><link rel="prefetch" href="/assets/js/11.43d1cb60.js"><link rel="prefetch" href="/assets/js/12.9a9e7822.js"><link rel="prefetch" href="/assets/js/14.5aad7bc8.js"><link rel="prefetch" href="/assets/js/15.e8ff7ea1.js"><link rel="prefetch" href="/assets/js/16.967d6edc.js"><link rel="prefetch" href="/assets/js/17.b11f3a3b.js"><link rel="prefetch" href="/assets/js/18.36889d7d.js"><link rel="prefetch" href="/assets/js/19.0c141602.js"><link rel="prefetch" href="/assets/js/20.6dfc17d2.js"><link rel="prefetch" href="/assets/js/21.1b2b9fe5.js"><link rel="prefetch" href="/assets/js/22.6f620733.js"><link rel="prefetch" href="/assets/js/23.f087f5cc.js"><link rel="prefetch" href="/assets/js/24.629fcd34.js"><link rel="prefetch" href="/assets/js/25.b48db0ed.js"><link rel="prefetch" href="/assets/js/26.2c48e6e9.js"><link rel="prefetch" href="/assets/js/27.a54c3537.js"><link rel="prefetch" href="/assets/js/28.787af08b.js"><link rel="prefetch" href="/assets/js/29.3c2337dd.js"><link rel="prefetch" href="/assets/js/3.0a0a58ce.js"><link rel="prefetch" href="/assets/js/30.d3a5877d.js"><link rel="prefetch" href="/assets/js/31.3f1cfebc.js"><link rel="prefetch" href="/assets/js/32.7c9f71a9.js"><link rel="prefetch" href="/assets/js/33.ee4cf5d0.js"><link rel="prefetch" href="/assets/js/34.3bf561ff.js"><link rel="prefetch" href="/assets/js/35.50e0d99e.js"><link rel="prefetch" href="/assets/js/36.b7f5d625.js"><link rel="prefetch" href="/assets/js/37.a8c65a8d.js"><link rel="prefetch" href="/assets/js/38.2d6f5286.js"><link rel="prefetch" href="/assets/js/39.684fcc9d.js"><link rel="prefetch" href="/assets/js/4.fb85282d.js"><link rel="prefetch" href="/assets/js/40.ad74dccd.js"><link rel="prefetch" href="/assets/js/41.b8a21708.js"><link rel="prefetch" href="/assets/js/42.be01eaa6.js"><link rel="prefetch" href="/assets/js/43.95c7afc9.js"><link rel="prefetch" href="/assets/js/44.8bcf98d3.js"><link rel="prefetch" href="/assets/js/45.ebd3354d.js"><link rel="prefetch" href="/assets/js/46.f9888560.js"><link rel="prefetch" href="/assets/js/47.a701acb1.js"><link rel="prefetch" href="/assets/js/48.902e553e.js"><link rel="prefetch" href="/assets/js/49.ccb4b3c7.js"><link rel="prefetch" href="/assets/js/5.9fb25b83.js"><link rel="prefetch" href="/assets/js/50.8c04e22a.js"><link rel="prefetch" href="/assets/js/51.546b5670.js"><link rel="prefetch" href="/assets/js/52.17981597.js"><link rel="prefetch" href="/assets/js/53.5af42f5e.js"><link rel="prefetch" href="/assets/js/54.6212ec14.js"><link rel="prefetch" href="/assets/js/55.a5f4a137.js"><link rel="prefetch" href="/assets/js/56.8b5d43ec.js"><link rel="prefetch" href="/assets/js/57.c8ba9b1a.js"><link rel="prefetch" href="/assets/js/6.a987cb54.js"><link rel="prefetch" href="/assets/js/7.1bbed2bb.js"><link rel="prefetch" href="/assets/js/8.5bbbf694.js"><link rel="prefetch" href="/assets/js/9.7c244008.js">
    <link rel="stylesheet" href="/assets/css/0.styles.534af037.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img.png" alt="smartboot 开源组织" class="logo"> <span class="site-name can-hide">smartboot 开源组织</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="📖开源文档" class="dropdown-title"><!----> <span class="title" style="display:;">📖开源文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/smart-socket/" class="nav-link router-link-active">smart-socket</a></li><li class="dropdown-item"><!----> <a href="/smart-http/" class="nav-link">smart-http</a></li><li class="dropdown-item"><!----> <a href="/smart-servlet/" class="nav-link">smart-servlet</a></li><li class="dropdown-item"><!----> <a href="/smart-mqtt/" class="nav-link">smart-mqtt</a></li><li class="dropdown-item"><!----> <a href="/smart-license/" class="nav-link">smart-license</a></li></ul></div></div><div class="nav-item"><a href="/donation.html" class="nav-link">❤️开源捐赠</a></div><div class="nav-item"><a href="/service.html" class="nav-link">💰付费服务</a></div><div class="nav-item"><a href="/join-us.html" class="nav-link">🏠加入社区</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开源仓库" class="dropdown-title"><!----> <span class="title" style="display:;">开源仓库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/smartboot" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/smartboot" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><!----> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="📖开源文档" class="dropdown-title"><!----> <span class="title" style="display:;">📖开源文档</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/smart-socket/" class="nav-link router-link-active">smart-socket</a></li><li class="dropdown-item"><!----> <a href="/smart-http/" class="nav-link">smart-http</a></li><li class="dropdown-item"><!----> <a href="/smart-servlet/" class="nav-link">smart-servlet</a></li><li class="dropdown-item"><!----> <a href="/smart-mqtt/" class="nav-link">smart-mqtt</a></li><li class="dropdown-item"><!----> <a href="/smart-license/" class="nav-link">smart-license</a></li></ul></div></div><div class="nav-item"><a href="/donation.html" class="nav-link">❤️开源捐赠</a></div><div class="nav-item"><a href="/service.html" class="nav-link">💰付费服务</a></div><div class="nav-item"><a href="/join-us.html" class="nav-link">🏠加入社区</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="开源仓库" class="dropdown-title"><!----> <span class="title" style="display:;">开源仓库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://gitee.com/smartboot" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Gitee
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/smartboot" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/smart-socket/" aria-current="page" class="sidebar-link">smart-socket 首页</a></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>概要</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/smart-socket/about.html" class="sidebar-link">关于 smart-socket</a></li><li><a href="/smart-socket/users.html" class="sidebar-link">我们的用户</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>快速上手</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/smart-socket/quickstart.html" class="sidebar-link">🚩五分钟上手</a></li><li><a href="/smart-socket/protocol.html" class="sidebar-link">🚩通信协议</a></li><li><a href="/smart-socket/performance.html" class="sidebar-link">性能压测</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>高级进阶</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/smart-socket/stateEvent.html" class="sidebar-link">1.状态机</a></li><li><a href="/smart-socket/bindIp.html" class="sidebar-link">2.服务端绑定网卡</a></li><li><a href="/smart-socket/low-memory.html" aria-current="page" class="active sidebar-link">3.低内存模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/smart-socket/low-memory.html#模式介绍" class="sidebar-link">模式介绍</a></li><li class="sidebar-sub-header level2"><a href="/smart-socket/low-memory.html#应用场景" class="sidebar-link">应用场景</a></li><li class="sidebar-sub-header level2"><a href="/smart-socket/low-memory.html#实现原理" class="sidebar-link">实现原理</a></li><li class="sidebar-sub-header level2"><a href="/smart-socket/low-memory.html#使用指南" class="sidebar-link">使用指南</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/smart-socket/low-memory.html#服务端启用方式" class="sidebar-link">服务端启用方式</a></li><li class="sidebar-sub-header level3"><a href="/smart-socket/low-memory.html#客户端启用方式" class="sidebar-link">客户端启用方式</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>插件</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/smart-socket/plugins.html" class="sidebar-link">1. 关于插件💬</a></li><li><a href="/smart-socket/plugin-heart.html" class="sidebar-link">2. 心跳插件插件</a></li><li><a href="/smart-socket/plugin-socket-option.html" class="sidebar-link">3. 通信调参插件</a></li><li><a href="/smart-socket/plugin-blacklist.html" class="sidebar-link">4. 黑名单插件🛡</a></li><li><a href="/smart-socket/plugin-ssl.html" class="sidebar-link">5. 加密通信插件🛡</a></li><li><a href="/smart-socket/plugin-rate-limiter.html" class="sidebar-link">6. 流量防控插件🛡</a></li><li><a href="/smart-socket/plugin-stream-monitor.html" class="sidebar-link">7. 码流监测插件🛡</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>💰付费阅读</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/smart-socket/million-connection.html" class="sidebar-link">单机百万长连接背后的故事</a></li></ul></section></li></ul> </aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><span data-v-06225672>smart-socket</span></li><li data-v-06225672><span data-v-06225672>高级进阶</span></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://gitee.com/smartdms" target="_blank" title="作者" class="beLink" data-v-06225672>三刀</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2023-01-08</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">3.低内存模式<!----></h1> <div class="page-slot page-slot-top">
    <div class="wwads-cn wwads-horizontal page-wwads" data-id="136"></div>
    <style>
      .page-wwads{
        width:100%!important;
        min-height: 0;
        margin: 0;
      }
      .page-wwads .wwads-img img{
        width:80px!important;
      }
      .page-wwads .wwads-poweredby{
        width: 40px;
        position: absolute;
        right: 25px;
        bottom: 3px;
      }
      .wwads-content .wwads-text, .page-wwads .wwads-text{
        height: 100%;
        padding-top: 5px;
        display: block;
      }
  </style>
  </div> <div class="theme-vdoing-content content__default"><h2 id="模式介绍"><a href="#模式介绍" class="header-anchor">#</a> 模式介绍</h2> <p>低内存模式是 smart-socket 技术创新的成果，<strong>这项特性在目前的 Java AIO 框架中是独一无二的</strong>。</p> <p>启用该模式后，可以实现通信过程中读缓冲区的按需分配。
在IO空闲期间释放读缓冲区内存，工作期间再申请一定的空间用于接收网络数据包，以此达到提升内存使用率的目的。</p> <h2 id="应用场景"><a href="#应用场景" class="header-anchor">#</a> 应用场景</h2> <p><strong>低内存模式尤其适合运用于海量连接且IO低密集型的场景</strong>。</p> <p>例如：物联网场景下数十万的设备与服务端建立着长连接，并周期性上报设备数据。</p> <p>假设每个连接的缓冲区大小是 1MB，对于一般的通信服务而言 10 万个连接将会消耗 9.7G 的内存。
而倘若启用 smart-socket 的低内存模式，这个内存开销或许只有几十兆至几百兆。</p> <div class="custom-block tip"><p class="custom-block-title">提示</p> <p>正是得益于这项技术，我们成功的在一台 8G 内存的服务器中实现了百万级长连接。
感兴趣的朋友可以访问：《<a href="/smart-socket/million-connection.html">单机百万级长连接背后的故事</a>》</p></div> <h2 id="实现原理"><a href="#实现原理" class="header-anchor">#</a> 实现原理</h2> <p>在讲解低内存模式的运行原理之前，我们有必要对 Java AIO 有一个基本的了解。</p> <p><code>AsynchronousSocketChannel#read</code>是 Java AIO 用于执行读操作的入口，该接口有三个入参：</p> <ol><li>dst：ByteBuffer缓冲区，用以存放收到的网络数据包。</li> <li>attachment：附件，可以是任意类型的对象。</li> <li>handler：读操作的回调处理器，当发生网络断连或者成功读取到数据后触发。</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AsynchronousSocketChannel</span> <span class="token keyword">implements</span> <span class="token class-name">AsynchronousByteChannel</span><span class="token punctuation">,</span> <span class="token class-name">NetworkChannel</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">A</span><span class="token punctuation">&gt;</span></span> <span class="token keyword">void</span> <span class="token function">read</span><span class="token punctuation">(</span><span class="token class-name">ByteBuffer</span> dst<span class="token punctuation">,</span> <span class="token class-name">A</span> attachment<span class="token punctuation">,</span> <span class="token class-name">CompletionHandler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token operator">?</span> <span class="token keyword">super</span> <span class="token class-name">A</span><span class="token punctuation">&gt;</span></span> f<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">read</span><span class="token punctuation">(</span>dst<span class="token punctuation">,</span> <span class="token number">0L</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">,</span> attachment<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>不得不承认 Java 在 AIO 接口的设计方面还是非常有水平的，它直接将 NIO 这种晦涩难懂又不易驾驭的复杂性，
简化至大多数Java程序员都能轻松驾驭的水准。</p> <p>但是这样的设计存在一个弊端便是对于内存资源的把控无法做到精细化，
在面对海量连接且IO低密集的情况，由于读通道长期处于监听状态，使大量的缓冲区内存处于静默状态（见下图）。
<img src="/assets/img/low-memory-1.1972cf2f.png" alt=""></p> <p><strong>所以原生的 Java AIO 不太适合这类海量连接的通信场景，但 smart-socket 通过重写通信内核彻底解决了该问题，
成为唯一一款性能和资源开销双优解的通信框架。</strong></p> <p>smart-socket 采取的策略便是在无法读到数据时及时释放缓冲区的内存空间，再进入通道监听状态。
直至通道中有数据可读时，再申请一片新缓冲区执行读操作（见下图）。</p> <p><img src="/assets/img/low-memory-2.7d24c54b.png" alt=""></p> <p>虽然从流程上是个微小的调整，却是一般 Java AIO 框架所无法实现的功能。
smart-socket也是在重写底层 AIO 实现后，才有能力感知通道状态并对内存资源作出优化配置。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">readCompleted</span><span class="token punctuation">(</span><span class="token keyword">int</span> result<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//释放缓冲区</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token class-name">EnhanceAsynchronousChannelProvider</span><span class="token punctuation">.</span><span class="token constant">READ_MONITOR_SIGNAL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>readBuffer<span class="token punctuation">.</span><span class="token function">clean</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>readBuffer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>result <span class="token operator">==</span> <span class="token class-name">EnhanceAsynchronousChannelProvider</span><span class="token punctuation">.</span><span class="token constant">READABLE_SIGNAL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">doRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 接收到的消息进行预处理</span>
    <span class="token class-name">NetMonitor</span> monitor <span class="token operator">=</span> config<span class="token punctuation">.</span><span class="token function">getMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>monitor <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        monitor<span class="token punctuation">.</span><span class="token function">afterRead</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>eof <span class="token operator">=</span> result <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>readBuffer<span class="token punctuation">.</span><span class="token function">buffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">flip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">signalRead</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>smart-socket 定义了两种信号量：</p> <ol><li>READ_MONITOR_SIGNAL
<ul><li>触发条件：当前缓冲区处于清空状态（即无半包）；当前TCP管道中无可读数据。</li> <li>执行动作：释放读缓冲区内存空间。</li></ul></li> <li>READABLE_SIGNAL
<ul><li>触发条件：TCP管道数据已就绪，具备可读条件。</li> <li>执行动作：申请读缓冲区内存空间，并触发读操作。</li></ul></li></ol> <h2 id="使用指南"><a href="#使用指南" class="header-anchor">#</a> 使用指南</h2> <p>由于低内存模式增加了内存释放和再申请两个环节，势必会产生些许的性能损耗。
不过这种损耗仅相对于极限性能压测而言，对实际应用的影响可谓微乎其微。
如果您的应用场景存在较高的连接数，大可放心启用低内存模式。</p> <h3 id="服务端启用方式"><a href="#服务端启用方式" class="header-anchor">#</a> 服务端启用方式</h3> <p>服务端启用低内存模式只需在启动时调用<code>AioQuickServer#setLowMemory</code>接口，并将入参设置为<code>true</code>。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">AioQuickServer</span> server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AioQuickServer</span><span class="token punctuation">(</span>port<span class="token punctuation">,</span> protocol<span class="token punctuation">,</span> processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">setLowMemory</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
server<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h3 id="客户端启用方式"><a href="#客户端启用方式" class="header-anchor">#</a> 客户端启用方式</h3> <p><strong>客户端一般没有低内存模式的需求，只有当你的服务内部管理着大量的客户端连接时才有意义。</strong></p> <p>通常这个时候我们建议这些客户端可以共享线程资源，所以客户端的低内存开关与线程资源组结合在一起。</p> <p>启用的方式也极为简单，只需在<code>EnhanceAsynchronousChannelProvider</code>的构造方法中指定<code>bool</code>值便可:</p> <ul><li>true: 启用低内存模式</li> <li>false: 禁用低内存模式</li></ul> <p>示例代码如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">AsynchronousChannelGroup</span> asynchronousChannelGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">EnhanceAsynchronousChannelProvider</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">openAsynchronousChannelGroup</span><span class="token punctuation">(</span><span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">availableProcessors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> r <span class="token operator">-&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token string">&quot;ClientGroup&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">AioQuickClient</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AioQuickClient</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> port<span class="token punctuation">,</span> protocol<span class="token punctuation">,</span> processor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">AioSession</span> session <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span>asynchronousChannelGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></div></div>  <div class="page-edit"><!----> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2023/01/11, 19:02:29</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/smart-socket/bindIp.html" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">2.服务端绑定网卡</div></a> <a href="/smart-socket/plugins.html" class="page-nav-centre page-nav-centre-next"><div class="tooltip">1. 关于插件💬</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/smart-socket/bindIp.html" class="prev">2.服务端绑定网卡</a></span> <span class="next"><a href="/smart-socket/plugins.html">1. 关于插件💬</a>→
      </span></p></div></div></div> <!----></main></div> <div class="footer"><div class="icons"><a href="mailto:zhengjunweimail@163.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/smthing" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://gitee.com/smartdms" title="GitHub" target="_blank" class="iconfont icon-gitee"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2017-2023
    <span>三刀</span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.b29c3e4e.js" defer></script><script src="/assets/js/2.16896ec1.js" defer></script><script src="/assets/js/13.60f68db7.js" defer></script>
  </body>
</html>
